<!DOCTYPE html>
<html>
<head>
    <title>Forester's Rations Calculator</title>
    <link href="https://fonts.cdnfonts.com/css/runescape-uf" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'runescape';
            src: url('frontend/fonts/runescape.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            background-color: #1f1f1f;
            color: #c5a245;
            font-family: 'runescape', sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            border: 4px solid #5a4a32;
            padding: 20px;
            background: #0f0f0f;
        }

        h1 {
            text-align: center;
            color: #ff981f;
            text-shadow: 2px 2px #000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 2px solid #5a4a32;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #2d2d2d;
        }

        tr:nth-child(even) {
            background-color: #1a1a1a;
        }

        .loading {
            text-align: center;
            font-size: 24px;
            display: none;
        }

        .item-icon {
            width: 32px;
            height: 32px;
            vertical-align: middle;
            margin-right: 8px;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Forester's Rations Calculator</h1>
        <div class="loading" id="loading">Calculating profits...</div>
        <table id="results">
            <thead>
                <tr>
                    <th>Leaf</th>
                    <th>Food</th>
                    <th>Profit</th>
                    <th>Rations</th>
                    <th>Leaf Price</th>
                    <th>Food Price</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <script>document.addEventListener('DOMContentLoaded', async function() {
            const loading = document.getElementById('loading');
            const resultsBody = document.getElementById('resultsBody');

            loading.style.display = 'block';

            try {
                // Define API endpoints and headers
                const headers = {
                    'Accept': 'application/json',
                    // Note: Browsers restrict setting User-Agent headers
                };
                const mappingUrl = 'https://prices.runescape.wiki/api/v1/osrs/mapping';
                const pricesUrl = 'https://prices.runescape.wiki/api/v1/osrs/latest';

                // Fetch data
                const [mappingRes, pricesRes] = await Promise.all([
                    fetch(mappingUrl, { headers }),
                    fetch(pricesUrl, { headers })
                ]);

                const mappingData = await mappingRes.json();
                const pricesData = (await pricesRes.json()).data;

                // Define game data
                const leavesToRations = {
                    "Leaves": 2,
                    "Oak leaves": 4,
                    "Willow leaves": 6,
                    "Maple leaves": 8,
                    "Yew leaves": 10,
                    "Magic leaves": 12
                };

                const cookingMultiplier = [
                    [1, 29, 1],
                    [30, 69, 2],
                    [70, 99, 3]
                ];

                const cookedFood = {
                    "Shrimps": 1,
                    "Anchovies": 1,
                    "Sardine": 1,
                    "Chicken": 2,
                    "Meat": 2,
                    "Herring": 5,
                    "Trout": 15,
                    "Pike": 15,
                    "Cod": 18,
                    "Salmon": 25,
                    "Slimy eel": 28,
                    "Tuna": 30,
                    "Karambwan": 30,
                    "Rainbow fish": 35,
                    "Cave eel": 35,
                    "Lobster": 40,
                    "Bass": 43,
                    "Swordfish": 45,
                    "Monkfish": 62,
                    "Shark": 80,
                    "Sea turtle": 82,
                    "Anglerfish": 84,
                    "Dark crab": 90,
                    "Manta ray": 91
                };

                // Process data
                const nameToId = {};
                mappingData.forEach(item => {
                    nameToId[item.name] = item.id;
                });

                const idToPrice = {};
                for (const [itemId, data] of Object.entries(pricesData)) {
                    const high = data.high;
                    const low = data.low;
                    if (high !== null && low !== null) {
                        idToPrice[itemId] = (high + low) / 2;
                    }
                }

                // Get Rations price
                const rationsId = nameToId["Forester's ration"];
                const rationsPrice = idToPrice[rationsId];

                if (!rationsPrice) throw new Error("Rations price unavailable");

                // Calculate all combinations
                const results = [];
                for (const [leaf, baseRations] of Object.entries(leavesToRations)) {
                    const leafId = nameToId[leaf];
                    const leafPrice = idToPrice[leafId];
                    if (!leafPrice) continue;

                    for (const [food, level] of Object.entries(cookedFood)) {
                        const foodId = nameToId[food];
                        const foodPrice = idToPrice[foodId];
                        if (!foodPrice) continue;

                        // Find multiplier
                        let multiplier = 1;
                        for (const [min, max, m] of cookingMultiplier) {
                            if (level >= min && level <= max) {
                                multiplier = m;
                                break;
                            }
                        }

                        const rationsCreated = baseRations * multiplier;
                        const profit = (rationsCreated * rationsPrice) - (leafPrice + foodPrice);

                        results.push({
                            Leaf: leaf,
                            Food: food,
                            Profit: profit,
                            Rations_Created: rationsCreated,
                            Leaf_Price: leafPrice,
                            Food_Price: foodPrice
                        });
                    }
                }

                // Sort and display top 10
                const top10 = results.sort((a, b) => b.Profit - a.Profit).slice(0, 10);

                resultsBody.innerHTML = top10.map(item => `
                    <tr>
                        <td>
                            <img src="https://oldschool.runescape.wiki/images/${item.Leaf.replace(/\s+/g, '_')}.png"
                                alt="${item.Leaf}" class="item-icon">
                            ${item.Leaf}
                        </td>
                        <td>
                            <img src="https://oldschool.runescape.wiki/images/${item.Food.replace(/\s+/g, '_')}.png"
                                alt="${item.Food}" class="item-icon">
                            ${item.Food}
                        </td>
                        <td>${Math.round(item.Profit).toLocaleString()} gp</td>
                        <td>${item.Rations_Created}</td>
                        <td>${Math.round(item.Leaf_Price).toLocaleString()} gp</td>
                        <td>${Math.round(item.Food_Price).toLocaleString()} gp</td>
                    </tr>
                `).join('');

                loading.style.display = 'none';

            } catch (error) {
                loading.style.display = 'none';
                resultsBody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`;
                console.error(error);
            }
        });</script>
</body>
</html>